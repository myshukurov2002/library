package com.company.library_project.service;import com.company.library_project.dto.ApiResponse;import com.company.library_project.dto.auth.JwtDTO;import com.company.library_project.entity.profile.EmailHistoryEntity;import com.company.library_project.entity.profile.ProfileEntity;import com.company.library_project.entity.profile.ProfileRoleEntity;import com.company.library_project.enums.Language;import com.company.library_project.enums.ProfileRole;import com.company.library_project.enums.ProfileStatus;import com.company.library_project.exp.AppBadRequestException;import com.company.library_project.repository.EmailHistoryRepository;import com.company.library_project.repository.ProfileRepository;import com.company.library_project.repository.ProfileRoleRepository;import com.company.library_project.util.HTMLUtil;import com.company.library_project.util.JWTUtil;import jakarta.mail.MessagingException;import jakarta.mail.internet.MimeMessage;import lombok.Setter;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.mail.javamail.JavaMailSender;import org.springframework.mail.javamail.MimeMessageHelper;import org.springframework.stereotype.Service;import java.nio.charset.StandardCharsets;import java.util.Optional;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Setter@Servicepublic class EmailSenderService {    @Autowired    private JavaMailSender javaMailSender;    @Autowired    private ProfileRepository profileRepository;    @Autowired    private EmailHistoryRepository emailHistoryRepository;    @Autowired    private ProfileRoleRepository profileRoleRepository;    @Value("${server.url}")    private String serverUrl;    @Value("${spring.mail.username}")    private String fromEmail;    @Autowired    private ResourceBundleService resourceBundleService;    void sendMimeEmail(String toAccount, String subject, String text) {        try {            MimeMessage msg = javaMailSender.createMimeMessage();            MimeMessageHelper helper = new MimeMessageHelper(msg, MimeMessageHelper.MULTIPART_MODE_MIXED_RELATED, StandardCharsets.UTF_8.name());            msg.setFrom(fromEmail);            helper.setTo(toAccount);            helper.setSubject(subject);            helper.setText(text, true);            javaMailSender.send(msg);        } catch (MessagingException e) {            throw new RuntimeException(e);        }    }    public ApiResponse<?> sendEmailVerification(String toAccount) {        ExecutorService executor = Executors.newSingleThreadExecutor();        String jwt = JWTUtil.encodeEmailJwt(toAccount);        String url = serverUrl + "/api/v1/auth/verification/email/" + jwt;        executor.submit(() -> {            sendMimeEmail(toAccount, "Library.com VERIFICATION", HTMLUtil.getRegistrationButton(url));            EmailHistoryEntity entity = new EmailHistoryEntity();            entity.setEmail(toAccount);            entity.setMessage(url);            emailHistoryRepository.save(entity);            executor.shutdown();        });        return new ApiResponse<>(true, resourceBundleService.getMessage("success.send.verification", Language.en) + "Confirm email verification");    }    public ApiResponse<?> emailVerification(String jwt, Language lang) {        JwtDTO jwtDTO = JWTUtil.decodeEmailJwt(jwt);        Optional<ProfileEntity> exists = profileRepository.findByEmail(jwtDTO.getEmail());        if (exists.isEmpty()) {            throw new AppBadRequestException("Profile not found");        }        ProfileEntity entity = exists.get();        if (!entity.getStatus().equals(ProfileStatus.REGISTRATION)) {            throw new AppBadRequestException("Wrong status");        }        sendResponse(jwtDTO.getEmail());        entity.setStatus(ProfileStatus.ACTIVE);        entity.setVisibility(true);        profileRepository.save(entity); // update        ProfileRoleEntity role = new ProfileRoleEntity(ProfileRole.USER, entity.getId());        profileRoleRepository.save(role);        return new ApiResponse<>(true, "Registration completed!");    }    public void sendResponse(String toEmail) {        try {            MimeMessage message = javaMailSender.createMimeMessage();            MimeMessageHelper helper = new MimeMessageHelper(message, MimeMessageHelper.MULTIPART_MODE_MIXED_RELATED, StandardCharsets.UTF_8.name());            helper.setTo(toEmail);            helper.setSubject("Registration email");            helper.setText(HTMLUtil.getResponse(), true);            javaMailSender.send(message);            System.out.println("SUCCESS SENT TO " + toEmail);        } catch (MessagingException e) {            throw new RuntimeException(e);        }    }}